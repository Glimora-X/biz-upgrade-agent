# 🚀 快速升级使用指南

## 概述

`快速升级` 是 `一键同步升级代码` 的精简版，专门用于 **Test** 和 **Inte** 环境的快速升级，提供更简洁的操作流程和更友好的交互体验。

## 适用场景

- ✅ Test 环境日常升级（`test-220918` ← `plus-upgrade-test`）
- ✅ Inte 环境日常升级（`sprint-251225` ← `plus-upgrade-sprint`）
- ✅ 无重大脚本变更的常规升级
- ✅ 需要快速完成的升级任务

## 命令列表

### 1. 快速升级（Test/Inte 环境）
- **命令**: `Biz Migration: 快速升级（Test/Inte 环境）`
- **快捷方式**: `Cmd+Shift+P` → 输入 `quick upgrade`

### 2. 继续快速升级流程
- **命令**: `Biz Migration: 继续快速升级流程`
- **用途**: 在冲突解决或单测修复后继续流程
- **快捷方式**: `Cmd+Shift+P` → 输入 `resume quick`

## 使用步骤

### 第一步：启动快速升级

1. 打开命令面板（`Cmd+Shift+P` 或 `Ctrl+Shift+P`）
2. 输入 `quick upgrade` 或 `快速升级`
3. 选择命令：`Biz Migration: 快速升级（Test/Inte 环境）`

### 第二步：选择升级环境

在弹出的选择框中选择要升级的环境：

- **Test 环境**：
  - 目标分支：`test-220918`
  - 源分支：`plus-upgrade-test`
  
- **Inte 环境**：
  - 目标分支：`sprint-251225`
  - 源分支：`plus-upgrade-sprint`

### 第三步：输入特性分支后缀

输入特性分支后缀（例如：`241219`），系统会自动拼接前缀：

- Test 环境：`@upgrade/test/241219`
- Inte 环境：`@upgrade/inte/241219`

> 💡 **提示**：默认值为当前日期（YYMMDD 格式）

### 第四步：等待自动执行

系统将自动执行以下步骤：

1. ✅ **前置检查**：检查 Git 仓库和工作区状态
2. 🔄 **切换分支**：切换到目标分支并拉取最新代码
3. 🌿 **创建特性分支**：创建或切换到特性分支
4. 🔀 **合并代码**：从源分支拉取代码
5. ⚠️ **冲突处理**（如有）：等待手动解决冲突
6. 📦 **执行升级脚本**：运行 `yarn upgrade`
7. 🧪 **运行单测**（可选）：可选择运行或跳过
8. 💾 **提交代码**：提交升级变更
9. 📤 **推送特性分支**：推送到远程仓库
10. 🔀 **合并到目标分支**：合并特性分支到目标分支
11. 📤 **推送目标分支**：推送目标分支到远程仓库
12. 🎉 **完成**：显示后续操作提示

## 冲突处理

### 当遇到冲突时

系统会：
1. 自动打开 **源代码管理（SCM）** 视图
2. 显示冲突文件列表
3. 在状态栏显示 `$(debug-pause) 等待继续升级...`
4. 暂停流程，等待手动解决

### 冲突处理规则

按照以下规则处理冲突：

1. **voucherconfig 冲突**：
   - 先保留当前分支版本
   - 之后再根据需要手动覆盖

2. **bizSchemaManager/bizApplication 冲突**：
   - 优先采用当前分支的版本

3. **引用冲突**：
   - 对比后按需选择新分支的版本

### 冲突解决后继续

解决所有冲突后：

1. 在 SCM 视图中暂存所有更改
2. 点击通知中的 **"继续"** 按钮，或
3. 执行命令：`Biz Migration: 继续快速升级流程`

## 单测处理

### 运行单测

系统会弹窗询问：

- **运行**：执行 `yarn test`
  - ✅ 通过：继续流程
  - ❌ 失败：提示修复，可选择继续或中止
  
- **跳过**：跳过单测，直接继续

### 单测失败处理

如果单测失败：

1. 在 IDE 中修复单测问题
2. 手动运行 `yarn test` 验证
3. 点击 **"继续"** 按钮继续流程

## 查看日志

所有 Git 操作和命令输出都会记录到 **Biz Quick Upgrade** 输出频道：

1. 打开输出面板：`Cmd+Shift+U`（或 `Ctrl+Shift+U`）
2. 选择 **"Biz Quick Upgrade"** 频道
3. 查看详细的执行日志

## 状态指示器

### 进度条

顶部通知栏显示：
- 当前步骤标题
- 进度：`步骤 X/总步骤数`

### 状态栏

暂停时状态栏左下角显示：
- `$(debug-pause) 等待继续升级...`
- 点击可快速继续流程

## 错误处理

### Git 命令失败

- 自动记录到输出频道
- 显示错误消息
- 提供 **"查看输出"** 按钮

### 用户取消

随时可以：
- 点击进度通知的 **"✕"** 按钮取消
- 点击冲突处理通知的 **"取消"** 按钮中止

### 工作区有未提交的更改

启动前会检查：
- 有更改：弹窗询问是否继续
- 无更改：直接执行

## 完成后操作

升级完成后，建议执行以下操作：

1. **部署环境**：
   - Test: 部署到 `pre-test` 环境
   - Inte: 部署到 `pre-inte` 环境

2. **功能验证**：
   - 验证核心功能是否正常
   - 检查升级相关的变更

3. **观察日志**：
   - 查看线上日志
   - 关注异常和错误

4. **回滚预案**：
   - 如有问题，可回滚到升级前的版本

## 与完整版的区别

| 特性 | 快速升级 | 一键同步升级 |
|------|---------|-------------|
| 适用场景 | Test/Inte 环境 | 所有场景 |
| 环境选择 | 固定两个选项 | 灵活配置 |
| 分支配置 | 预设（自动） | 手动输入 |
| 操作步骤 | 2 步 | 5+ 步 |
| 推送到多仓库 | ❌ | ✅ |
| 重建分支模式 | ❌ | ✅ |
| 源仓库推送 | ❌ | ✅ |

## 常见问题

### Q: 如何中途取消升级？

A: 点击进度通知右上角的 **"✕"** 按钮，或在冲突处理时选择 **"取消"**。

### Q: 可以同时运行多个升级吗？

A: 不可以，每次只能运行一个升级流程。

### Q: 特性分支已存在会怎样？

A: 系统会自动切换到该分支，而不是创建新分支。

### Q: 如何修改目标分支或源分支？

A: 如需自定义分支，请使用完整版命令：`Biz Migration: 一键同步升级代码`。

### Q: 升级失败如何回滚？

A: 使用 Git 命令回滚：
```bash
git checkout <目标分支>
git reset --hard origin/<目标分支>
```

## 技术细节

### 环境配置映射

```typescript
const branchMap = {
  test: {
    targetBranch: 'test-220918',
    sourceBranch: 'plus-upgrade-test',
  },
  inte: {
    targetBranch: 'sprint-251225',
    sourceBranch: 'plus-upgrade-sprint',
  },
};
```

### 特性分支命名规则

```
@upgrade/{env}/{suffix}

示例：
- @upgrade/test/241219
- @upgrade/inte/250101
```

### 提交信息格式

```
chore: upgrade from {源分支}

示例：
- chore: upgrade from plus-upgrade-test
- chore: upgrade from plus-upgrade-sprint
```

## 开发调试

### 查看详细日志

打开 VS Code 开发者工具：
```
帮助 → 切换开发人员工具
```

### 强制刷新扩展

```bash
# 重新编译
npm run compile

# 重新加载窗口
Cmd+Shift+P → "Reload Window"
```

## 反馈与支持

遇到问题？请提供以下信息：

1. 执行的命令
2. 选择的环境
3. 输出频道的完整日志
4. 错误截图

## 更新日志

### v4.1.0 (当前版本)

- ✨ 新增快速升级命令
- 🎨 优化用户交互体验
- 🐛 改进冲突检测机制
- 📝 增强日志输出

---

**祝升级顺利！** 🎉

