# 优化说明 - 自定义提交信息

## 🎯 需求

在提交升级变更时，允许用户自定义填写提交信息（Commit Message），而不是使用固定的提交信息。

## 📝 修改内容

### 优化前

```typescript
// 固定的提交信息
await this.execLogged(`git commit -m "chore: upgrade from ${sourceBranch}"`, cwd);
```

**问题**：
- ❌ 提交信息固定，无法自定义
- ❌ 无法根据实际升级内容调整描述
- ❌ 不够灵活

### 优化后

```typescript
// 1. 弹出输入框，让用户填写提交信息
const defaultMessage = `chore: upgrade from ${sourceBranch}`;
const commitMessage = await vscode.window.showInputBox({
  prompt: '请输入提交信息（Commit Message）',
  placeHolder: '例如：chore: upgrade from plus-test-250918',
  value: defaultMessage,  // 提供默认值
  title: '提交升级变更',
  validateInput: (value) => {
    if (!value || !value.trim()) {
      return '提交信息不能为空';
    }
    return null;
  },
});

// 2. 处理用户取消输入
if (!commitMessage) {
  const choice = await vscode.window.showWarningMessage(
    '未填写提交信息，是否跳过提交？',
    { modal: true },
    '跳过提交',
    '重新填写',
    '中止流程'
  );

  if (choice === '重新填写') {
    return this.commitChanges(sourceBranch, cwd);
  } else if (choice === '中止流程') {
    throw new Error('用户取消：未填写提交信息');
  } else {
    this.output.appendLine('⏭️  跳过提交\n');
    return;
  }
}

// 3. 提交（转义特殊字符）
await this.execLogged(`git commit -m "${commitMessage.replace(/"/g, '\\"')}"`, cwd);
```

## 🎨 用户体验

### 工作流程

```
执行 git add .
  ↓
弹出输入框
╭────────────────────────────────────╮
│ 提交升级变更                       │
│                                    │
│ 请输入提交信息（Commit Message）   │
│                                    │
│ [chore: upgrade from plus-test...] │ ← 默认值
│                                    │
│ 例如：chore: upgrade from...       │ ← 提示
│                                    │
│         [取消]      [确定]         │
╰────────────────────────────────────╯
  ↓
用户可以：
1. 使用默认值（直接点确定）
2. 修改为自定义内容
3. 点击取消
```

### 场景 1：使用默认值

```
用户点击"确定"（或按 Enter）
  ↓
使用默认提交信息
  ↓
git commit -m "chore: upgrade from plus-test-250918"
  ↓
✅ 变更已提交
```

### 场景 2：自定义内容

```
用户修改为自定义内容
例如："feat: upgrade bizcore to latest version"
  ↓
点击"确定"
  ↓
git commit -m "feat: upgrade bizcore to latest version"
  ↓
✅ 变更已提交
```

### 场景 3：取消输入

```
用户点击"取消"
  ↓
弹出确认对话框
╭────────────────────────────────────╮
│ ⚠️ 警告                            │
│                                    │
│ 未填写提交信息，是否跳过提交？     │
│                                    │
│  [跳过提交] [重新填写] [中止流程]  │
╰────────────────────────────────────╯
```

**选择 "跳过提交"**：
```
⏭️  跳过提交
  ↓
继续后续步骤（推送分支等）
```

**选择 "重新填写"**：
```
重新弹出输入框
  ↓
用户可以重新填写
```

**选择 "中止流程"**：
```
❌ 用户取消：未填写提交信息
  ↓
终止整个升级流程
```

## 🔒 输入验证

### 验证规则

```typescript
validateInput: (value) => {
  if (!value || !value.trim()) {
    return '提交信息不能为空';
  }
  return null;
}
```

**效果**：
- ✅ 提交信息不能为空
- ✅ 提交信息不能只包含空格
- ✅ 输入无效时，输入框会显示错误提示
- ✅ 无法点击"确定"按钮

### 特殊字符处理

```typescript
// 转义双引号，避免命令执行错误
commitMessage.replace(/"/g, '\\"')
```

**示例**：
```typescript
// 输入：fix: resolve "merge conflict" issue
// 转义后：fix: resolve \"merge conflict\" issue
// 命令：git commit -m "fix: resolve \"merge conflict\" issue"
```

## 💡 技术细节

### 1. 递归调用

```typescript
if (choice === '重新填写') {
  return this.commitChanges(sourceBranch, cwd);
}
```

**好处**：
- 用户可以多次重新填写
- 代码简洁，复用逻辑

**注意**：
- 需要显式声明返回类型 `Promise<void>`
- 避免 TypeScript 报错

### 2. 默认值

```typescript
value: defaultMessage,  // 默认值：chore: upgrade from ${sourceBranch}
```

**好处**：
- 用户可以直接按 Enter 使用默认值
- 也可以基于默认值修改
- 提高效率

### 3. 模态对话框

```typescript
{ modal: true }
```

**好处**：
- 确保用户看到并做出选择
- 阻塞后续操作
- 避免误操作

## 📊 对比表

| 方面 | 优化前 | 优化后 |
|------|--------|--------|
| **提交信息** | 固定 | 用户自定义 |
| **灵活性** | ❌ 无 | ✅ 高 |
| **默认值** | ✅ 有 | ✅ 有 |
| **验证** | ❌ 无 | ✅ 有 |
| **取消处理** | ❌ 无 | ✅ 有 |
| **重新填写** | ❌ 无 | ✅ 支持 |
| **跳过提交** | ❌ 无 | ✅ 支持 |

## 🎨 提交信息示例

### 使用默认格式

```
chore: upgrade from plus-test-250918
```

### 自定义格式 - 语义化提交

```
feat: upgrade bizcore to v2.0.0

- 升级核心依赖
- 修复兼容性问题
- 优化性能
```

### 自定义格式 - 简短描述

```
升级 bizcore 核心库
```

### 自定义格式 - 带 Issue 编号

```
chore: upgrade from plus-test-250918 (#123)
```

### 自定义格式 - 带团队前缀

```
[Team-A] chore: upgrade from plus-test-250918
```

## ✅ 修改清单

- [x] ✅ 添加输入框让用户填写提交信息
- [x] ✅ 提供默认值
- [x] ✅ 添加输入验证（不能为空）
- [x] ✅ 处理用户取消输入
- [x] ✅ 支持"跳过提交"选项
- [x] ✅ 支持"重新填写"选项
- [x] ✅ 支持"中止流程"选项
- [x] ✅ 转义特殊字符（双引号）
- [x] ✅ 显式声明返回类型 `Promise<void>`
- [x] ✅ 编译通过
- [x] ✅ 优化说明文档

## 🚀 测试验证

### 测试步骤

1. **重新加载窗口**
   ```
   Cmd+Shift+P → Reload Window
   ```

2. **运行快速升级**
   ```
   Cmd+Shift+P → Biz Migration: 快速升级（Test/Inte 环境）
   ```

3. **执行到提交步骤**
   - 完成升级脚本
   - 完成单测（或跳过）
   - 进入提交步骤

4. **测试输入框**
   - ✅ 弹出输入框
   - ✅ 显示默认提交信息
   - ✅ 显示提示文本

5. **测试场景**
   
   **场景 A：使用默认值**
   - 直接点击"确定"或按 Enter
   - ✅ 使用默认提交信息
   - ✅ 成功提交

   **场景 B：自定义内容**
   - 修改为自定义提交信息
   - 点击"确定"
   - ✅ 使用自定义提交信息
   - ✅ 成功提交

   **场景 C：输入为空**
   - 删除所有内容
   - ✅ 显示错误提示："提交信息不能为空"
   - ✅ 无法点击"确定"

   **场景 D：取消输入 → 跳过提交**
   - 点击"取消"
   - 弹出确认对话框
   - 选择"跳过提交"
   - ✅ 跳过提交
   - ✅ 继续后续步骤

   **场景 E：取消输入 → 重新填写**
   - 点击"取消"
   - 选择"重新填写"
   - ✅ 重新弹出输入框
   - ✅ 可以重新填写

   **场景 F：取消输入 → 中止流程**
   - 点击"取消"
   - 选择"中止流程"
   - ✅ 终止整个升级流程

### 预期结果

```
✅ 输入框正常弹出
✅ 默认值正确显示
✅ 输入验证正常工作
✅ 可以使用默认值
✅ 可以自定义内容
✅ 可以跳过提交
✅ 可以重新填写
✅ 可以中止流程
✅ 特殊字符正确转义
✅ 提交成功
```

## 💡 使用建议

### 推荐的提交信息格式

1. **语义化提交（Conventional Commits）**
   ```
   <type>(<scope>): <subject>
   
   例如：
   - feat(core): upgrade bizcore to v2.0.0
   - chore(deps): upgrade from plus-test-250918
   - fix(upgrade): resolve merge conflicts
   ```

2. **简短描述**
   ```
   简单明了地描述变更
   
   例如：
   - 升级 bizcore 核心库到最新版本
   - 合并 test 环境升级代码
   ```

3. **带详细说明**
   ```
   <简短标题>
   
   <详细描述>
   
   例如：
   chore: upgrade bizcore core library
   
   - Upgrade from plus-test-250918
   - Fix compatibility issues
   - Update dependencies
   - Run all unit tests
   ```

### 快捷操作

- **使用默认值**：直接按 `Enter` 键
- **修改部分内容**：使用键盘快捷键（Cmd+A 全选，然后修改）
- **取消后重新填写**：可以多次重新尝试

## 🎉 完成

现在提交升级变更时：
- ✅ 可以自定义提交信息
- ✅ 有合理的默认值
- ✅ 有输入验证
- ✅ 支持取消和重新填写
- ✅ 支持跳过提交
- ✅ 更加灵活和用户友好

**请重新加载窗口并测试！** 🚀

---

*优化时间: 2024-12-19*
*优化内容: 允许用户自定义提交信息*
*相关方法: commitChanges()*

